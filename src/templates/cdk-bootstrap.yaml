AWSTemplateFormatVersion: '2010-09-09'
Description: CDK Bootstrap Stack for Innovation Sandbox

Parameters:
  TrustedAccounts:
    Description: List of AWS accounts that can assume CDK roles
    Default: ''
    Type: CommaDelimitedList
  CloudFormationExecutionPolicies:
    Description: ARN of IAM policies for CloudFormation execution role
    Type: CommaDelimitedList
    Default: 'arn:aws:iam::aws:policy/AdministratorAccess'
  Qualifier:
    Description: Qualifier for CDK resources
    Type: String
    Default: 'hnb659fds'
    AllowedPattern: '[A-Za-z0-9_-]{1,10}'
  BootstrapVariant:
    Type: String
    Default: 'AWS CDK: Default Resources'

Resources:
  # SSM Parameter for bootstrap version - required for CDK to detect bootstrap
  CdkBootstrapVersion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/cdk-bootstrap/${Qualifier}/version'
      Type: String
      Value: '21'
      Description: CDK Bootstrap Version

  # S3 Bucket for CDK assets (optional but recommended)
  StagingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'cdk-${Qualifier}-assets-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !GetAtt StagingBucketKey.Arn
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupOldVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 365
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain

  StagingBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StagingBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowSSLRequestsOnly
            Effect: Deny
            Principal: '*'
            Action: s3:*
            Resource:
              - !GetAtt StagingBucket.Arn
              - !Sub '${StagingBucket.Arn}/*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'

  StagingBucketKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for CDK staging bucket
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: kms:*
            Resource: '*'

  StagingBucketKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/cdk-${Qualifier}-key'
      TargetKeyId: !Ref StagingBucketKey

  # ECR Repository for container assets
  ContainerAssetsRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub 'cdk-${Qualifier}-container-assets-${AWS::AccountId}-${AWS::Region}'
      ImageTagMutability: IMMUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      EncryptionConfiguration:
        EncryptionType: AES256
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Expire untagged images older than 30 days",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "sinceImagePushed",
                  "countUnit": "days",
                  "countNumber": 30
                },
                "action": {
                  "type": "expire"
                }
              }
            ]
          }
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain

  # IAM Role for CloudFormation execution
  CloudFormationExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-cfn-exec-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Select [0, !Ref CloudFormationExecutionPolicies]

  # IAM Role for CDK deployments
  DeploymentActionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-deploy-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DeploymentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:CreateStack
                  - cloudformation:UpdateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackEvents
                  - cloudformation:GetTemplate
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - !GetAtt StagingBucket.Arn
                  - !Sub '${StagingBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:Encrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt StagingBucketKey.Arn
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt CloudFormationExecutionRole.Arn
              - Effect: Allow
                Action:
                  - ecr:*
                Resource: !GetAtt ContainerAssetsRepository.Arn
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/cdk-bootstrap/*'

  # IAM Role for file publishing (assets)
  FilePublishingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-file-publishing-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FilePublishingPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject*
                  - s3:GetBucket*
                  - s3:List*
                  - s3:DeleteObject*
                  - s3:PutObject*
                  - s3:Abort*
                Resource:
                  - !GetAtt StagingBucket.Arn
                  - !Sub '${StagingBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:Encrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt StagingBucketKey.Arn

  # IAM Role for image publishing (container assets)
  ImagePublishingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-image-publishing-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ImagePublishingPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: '*'
              - Effect: Allow
                Action:
                  - ecr:*
                Resource: !GetAtt ContainerAssetsRepository.Arn

  # IAM Role for lookups
  LookupRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-lookup-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/ReadOnlyAccess'
      Policies:
        - PolicyName: LookupPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Deny
                Action:
                  - kms:Decrypt
                Resource: '*'

Outputs:
  BucketName:
    Description: S3 bucket for CDK assets
    Value: !Ref StagingBucket
  BucketDomainName:
    Description: S3 bucket domain name
    Value: !GetAtt StagingBucket.RegionalDomainName
  BootstrapVersion:
    Description: Bootstrap version
    Value: !GetAtt CdkBootstrapVersion.Value
  ImageRepositoryName:
    Description: ECR repository for container images
    Value: !Ref ContainerAssetsRepository
